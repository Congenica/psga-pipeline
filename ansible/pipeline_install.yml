---
- hosts: all
  gather_facts: true
  become: false

  # Ensure that valid credentials can be provided when requested by the playbook.

  vars_files:
    - vars/env_vars.yml

  vars_prompt:
    - name: db_host
      prompt: 'Database hostname/ip '
      private: no
      default: "{{ lookup('env', 'DB_HOST') | default('localhost', True) }}"
    - name: db_name
      prompt: 'Database logical name '
      private: no
      default: "{{ lookup('env', 'DB_NAME') | default('psga_db', True) }}"
    - name: db_user
      prompt: 'Database username '
      private: no
      default: "{{ lookup('env', 'DB_USER') | default('postgres', True) }}"
    - name: db_port
      prompt: 'Database port '
      private: no
      default: "{{ lookup('env', 'DB_PORT') | default('5432', True) }}"
    - name: db_password
      prompt: 'Database password '
      private: yes
      confirm: yes
    - name: psga_root_path
      prompt: 'Root dir of the pipeline '
      private: no
      default: '${HOME}/psga'
    - name: psga_input_path
      prompt: 'Path to FASTQ/BAM files for pipeline '
      private: no
      default: '${HOME}/psga-input'
    - name: psga_output_path
      prompt: 'Work dir of the pipeline '
      private: no
      default: '${HOME}/psga-output'
    - name: psga_reports_path
      prompt: 'Report path for pipeline '
      private: no
      default: '${HOME}/psga-reports'

  roles:
    - { role: install-os-packages, yum_update: false, become: true }
    - { role: install-nextflow }
    - { role: build-pangolin }
    - { role: build-ncov }
    - { role: build-psga }
    - { role: build-nextstrain }
    - { role: build-auspice }
    - { role: run-sqitch }
    - { role: post-install-setup }
