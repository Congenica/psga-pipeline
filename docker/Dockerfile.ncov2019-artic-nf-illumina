FROM condaforge/mambaforge:4.14.0-0 AS condabuild

# REQUIREMENTS:
# * run docker/clone_ncov2019-artic-nf.sh and git add docker/sars_cov_2/ncov2019-artic-nf_illumina.yml docker/sars_cov_2/ncov2019-artic-nf_nanopore.yml docker/sars_cov_2/ncov2019-artic-nf_extras.yml
# * run docker/get_sars_cov_2_primers.sh and git add docker/primer_schemes

ARG pathogen
COPY docker/${pathogen}/ncov2019-artic-nf_illumina.yml /environment.yml
COPY docker/${pathogen}/ncov2019-artic-nf_extras.yml /extras.yml
# Also reinstall packages to pinned versions, as the conda-selected downgraded ones fail to run
RUN mamba env create -f /environment.yml -n custom_env \
  && mamba env update -f /extras.yml -n custom_env \
  && mamba install -y -c conda-forge -c bioconda cutadapt==3.1 dnaio==0.4.4 -n custom_env \
  && conda clean --all -y


FROM debian:buster-slim
RUN apt-get update \
  && apt-get install -y --no-install-recommends git procps rename \
  && apt-get clean -y \
  && rm -rf /var/lib/apt/lists/*

COPY --from=condabuild /opt/conda/envs/custom_env /opt/conda/envs/custom_env

ENV PATH=/ncov2019-artic-nf/bin:/opt/conda/envs/custom_env/bin:$PATH

ARG pathogen
COPY docker/${pathogen}/ncov.deps psga/${pathogen}/ncov-illumina.config psga/${pathogen}/ncov-common.config /
COPY data/${pathogen}/primer_schemes /primer_schemes

# install awscli here because the conda version requires a much more updated Python version
RUN . /ncov.deps \
  && pip install awscli==1.20.50 \
  && export GIT_SSL_NO_VERIFY=1 \
  && git clone --recursive https://github.com/Congenica/ncov2019-artic-nf.git \
  && cd /ncov2019-artic-nf \
  && git checkout ${ncov_commit}
