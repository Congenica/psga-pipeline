manifest {
    name = 'COVID pipeline'
    description = 'COVID pipeline'
    nextflowVersion = '>= 21.10.4'
    version = '1.0.0'
}

includeConfig 'executor.config'
includeConfig 'ncov-custom.config'

env {
    DB_HOST = "${DB_HOST}"
    DB_PORT = "${DB_PORT}"
    DB_NAME = "${DB_NAME}"
    DB_USER = "${DB_USER}"
    DB_PASSWORD = "${DB_PASSWORD}"
    COVID_PIPELINE_ROOT_PATH = "${COVID_PIPELINE_ROOT_PATH}"
    COVID_PIPELINE_INPUT_PATH = "${COVID_PIPELINE_INPUT_PATH}"
    COVID_PIPELINE_OUTPUT_PATH = "${COVID_PIPELINE_OUTPUT_PATH}"

    // The following env vars are set internally and should not be changed
    COVID_PIPELINE_MISSING_METADATA_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/no-metadata-found-bam"
    COVID_PIPELINE_NCOV_OUTPUT_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/ncov2019-artic"
    COVID_PIPELINE_QC_PLOTS_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/qc-plots"
    COVID_PIPELINE_FASTA_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/reheadered-fasta"
    COVID_PIPELINE_FASTA_PATH_QC_FAILED = "${env.COVID_PIPELINE_OUTPUT_PATH}/reheadered-fasta-qc-failed"
    COVID_PIPELINE_PANGOLIN_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/pangolin"
    COVID_PIPELINE_GENBANK_PATH = "${COVID_PIPELINE_OUTPUT_PATH}/genbank"
    COVID_PIPELINE_NOTIFICATIONS_PATH = "${COVID_PIPELINE_OUTPUT_PATH}/notifications"
}

params {
    // INTERNAL PARAMETER
    // A parameter, required by the methods makeFastqSearchPath, makeBamSearchPath and makeNanoporeSearchPath
    directory = env.COVID_PIPELINE_INPUT_PATH

    // EXTERNAL PARAMETERS
    // parameter for process concatenate_fasta
    root_genome_fasta = "/app/data/FASTA/SARS-CoV-2.fasta"

    // parameter for GenBank submission template, which is generated
    // at website https://submit.ncbi.nlm.nih.gov/genbank/template/submission/
    // provided default file is an example one. Make sure to generate your own
    // template file
    genbank_submission_template = "${COVID_PIPELINE_ROOT_PATH}/data/GenBank/template.example.sbt"

    // comment to be added to each submission to GenBank
    genbank_submission_comment = "Bahrain SARS-Cov-2 genome submission"

    // User account name that will be provided when the submission account is established.
    // Example: "congenica"
    genbank_submitter_name = ""

    // Center/account abbreviation provided during account creation in MyNCBI.
    // Example: "congenica"
    genbank_submitter_account_namespace = ""

    // Static value to add to every submission ID for GenBank
    genbank_submission_id_suffix = "bahrain-sars-cov-2"

    // GenBank remote storage information with credentials
    genbank_storage_remote_url = "ftp-private.ncbi.nlm.nih.gov"
    genbank_storage_remote_username = ""
    genbank_storage_remote_password = ""

    // Set to "Test" for making test submissions for GenBank submission portal
    // Set to "Production" to actually submit sequences to GenBank for further analysis
    genbank_storage_remote_directory = "Test"

    // parameter for process load_metadata
    metadata_file_name = "metadata.tsv"

    // available workflows: 'illumina_artic' or 'medaka_artic' (nanopore)
    workflow = "illumina_artic"

    // fastq or bam
    filetype = "fastq"

    // the name for this analysis
    run = ""
}

/*
The directive `errorStrategy` is set to `ignore` for ncov processes.
This prevents that a failing sample compromises the whole batch.
*/

process {
    executor = 'k8s'

    withName:load_metadata {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:append_match_to_current_session_samples {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_notification_updated {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_notification_processed_already {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:reheader_genome_fasta {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "1 GB"
    }

    if ( params.workflow == "illumina_artic" ) {
        withName:ncov2019_artic_nf_pipeline_illumina {
            container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019_artic_nf_illumina:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "2 GB"
            errorStrategy = "ignore"
        }
        if ( params.filetype == "fastq" ) {
            withName:append_metadata_match_to_sample_file_pair {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:append_qc_pass_match_to_fastq_samples {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:store_notification_no_fastq_file {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:store_notification_fastq_only {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:store_fastas_not_matched {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
        } else if ( params.filetype == "bam" ) {
            withName:append_metadata_match_to_sample_file {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:append_qc_pass_match_to_bam_samples {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:bam_to_fastq {
                container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019_artic_nf_illumina:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "2 GB"
            }
            withName:store_bams_not_matched {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:store_notification_no_bam_file {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
            withName:store_notification_bam_only {
                container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
                cpus = "1"
                memory = "500 MB"
            }
        }
    }

    if ( params.workflow == "medaka_artic" ) {
        withName:append_metadata_match_to_sample_file {
            container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "500 MB"
        }
        withName:ncov2019_artic_nf_pipeline_medaka {
            container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019_artic_nf_nanopore:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "4 GB"
            errorStrategy = "ignore"
        }
        withName:append_qc_pass_match_to_nanopore_samples {
            container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "500 MB"
        }
        withName:store_nanopore_not_matched {
            container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "500 MB"
        }
        withName:store_notification_no_nanopore_file {
            container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "500 MB"
        }
        withName:store_notification_nanopore_only {
            container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
            cpus = "1"
            memory = "500 MB"
        }
    }

    withName:store_ncov_qc_plots {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_ncov2019_artic_nf_output {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:load_ncov_assembly_qc_to_db {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_reheadered_fasta_passed {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_reheadered_fasta_failed {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:pangolin_pipeline {
        container = "${env.DOCKER_IMAGE_PREFIX}/pangolin:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "2 GB"
    }
    withName:load_pangolin_data_to_db {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:create_genbank_submission_files {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:store_genbank_submission {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:submit_genbank_files {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:mark_samples_as_submitted_to_genbank {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "500 MB"
    }
    withName:pipeline_complete {
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        cpus = "1"
        memory = "250 MB"
    }
}
