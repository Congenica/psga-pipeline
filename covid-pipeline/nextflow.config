manifest {
    name = 'COVID pipeline'
    description = 'COVID pipeline'
    nextflowVersion = '>= 21.10.4'
    version = '1.0.0'
}

includeConfig 'executor.config'
includeConfig 'ncov-custom.config'

env {
    DB_HOST = "${DB_HOST}"
    DB_PORT = "${DB_PORT}"
    DB_NAME = "${DB_NAME}"
    DB_USER = "${DB_USER}"
    DB_PASSWORD = "${DB_PASSWORD}"
    COVID_PIPELINE_ROOT_PATH = "${COVID_PIPELINE_ROOT_PATH}"
    COVID_PIPELINE_INPUT_PATH = "${COVID_PIPELINE_INPUT_PATH}"
    COVID_PIPELINE_OUTPUT_PATH = "${COVID_PIPELINE_OUTPUT_PATH}"

    // The following env vars are set internally and should not be changed
    COVID_PIPELINE_MISSING_METADATA_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/no-metadata-found-bam"
    COVID_PIPELINE_NCOV_OUTPUT_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/ncov2019-artic"
    COVID_PIPELINE_QC_PLOTS_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/qc-plots"
    COVID_PIPELINE_FASTA_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/reheadered-fasta"
    COVID_PIPELINE_FASTA_PATH_QC_FAILED = "${env.COVID_PIPELINE_OUTPUT_PATH}/reheadered-fasta-qc-failed"
    COVID_PIPELINE_PANGOLIN_PATH = "${env.COVID_PIPELINE_OUTPUT_PATH}/pangolin"
    COVID_PIPELINE_GENBANK_PATH = "${COVID_PIPELINE_OUTPUT_PATH}/genbank"
    COVID_PIPELINE_NOTIFICATIONS_PATH = "${COVID_PIPELINE_OUTPUT_PATH}/notifications"
}

params {
    // An internal parameter, required by the methods makeFastqSearchPath, makeBamSearchPath and makeNanoporeSearchPath
    directory = env.COVID_PIPELINE_INPUT_PATH

    /* GENBANK */
    // parameter for GenBank submission template, which is generated
    // at website https://submit.ncbi.nlm.nih.gov/genbank/template/submission/
    // provided default file is an example one. Make sure to generate your own
    // template file
    genbank_submission_template = "${COVID_PIPELINE_ROOT_PATH}/data/GenBank/template.example.sbt"
    // comment to be added to each submission to GenBank
    genbank_submission_comment = "United Kingdom SARS-Cov-2 genome submission"
    // User account name that will be provided when the submission account is established.
    // Example: "congenica"
    genbank_submitter_name = ""
    // Center/account abbreviation provided during account creation in MyNCBI.
    // Example: "congenica"
    genbank_submitter_account_namespace = ""
    // Static value to add to every submission ID for GenBank
    genbank_submission_id_suffix = "bahrain-sars-cov-2"
    // GenBank remote storage information with credentials
    genbank_storage_remote_url = "ftp-private.ncbi.nlm.nih.gov"
    genbank_storage_remote_username = ""
    genbank_storage_remote_password = ""
    // Set to "Test" for making test submissions for GenBank submission portal
    // Set to "Production" to actually submit sequences to GenBank for further analysis
    genbank_storage_remote_directory = "Test"

    /* LOAD METADATA */
    metadata_file_name = "metadata.tsv"

    /* PIPELINE MAIN INPUT PARAMETERS */
    // primer-schema for ncov-artic pipeline
    // scheme_repo_url = "https://github.com/artic-network/primer-schemes.git"
    // for efficiency, the repo was checked out in our ncov2019-artic-nf docker images
    scheme_repo_url = "/artic-network/primer-schemes"
    // Directory within schemeRepoURL that contains primer schemes
    scheme_dir = "primer-schemes"
    // Scheme name
    scheme = "nCoV-2019"
    // Scheme version
    scheme_version = "V3"

    // choices: 'illumina_artic' | 'medaka_artic' (nanopore)
    workflow = "illumina_artic"
    // choices: fastq | bam
    filetype = "fastq"
    // the name for this analysis
    run = "test_run"
}

process {
    // default directives. These can be fine-tuned per process
    // use the local executor by default, so that the filtering-processes (which are only used for organising files) and any
    // dummy processes (e.g. pipeline complete) are executed in the same container where the main pipeline runs.
    executor = 'local'
    cpus = "${env.K8S_PROCESS_CPU_LOW}"
    memory = { "${env.K8S_PROCESS_MEMORY_LOW}" as int * 1.MB * task.attempt }
    maxRetries = "${env.K8S_PROCESS_MAX_RETRIES}"
    errorStrategy = { (task.exitStatus in 137..140 && task.attempt <= "${env.K8S_PROCESS_MAX_RETRIES}" as int) ? 'retry' : 'terminate' }

    withName:load_metadata {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:reheader_genome_fasta {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
        memory = { "${env.K8S_PROCESS_MEMORY_MEDIUM}" as int * 1.MB * task.attempt }
    }

    if ( params.workflow == "illumina_artic" ) {
        // use more memory as this process runs a nextflow pipeline (Java)
        withName:ncov2019_artic_nf_pipeline_illumina {
            executor = 'k8s'
            container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019-artic-nf-illumina:${env.DOCKER_IMAGE_TAG}"
            memory = { "${env.K8S_PROCESS_MEMORY_VERY_HIGH}" as int * 1.MB * task.attempt }
        }
        if ( params.filetype == "bam" ) {
            withName:bam_to_fastq {
                executor = 'k8s'
                container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019-artic-nf-illumina:${env.DOCKER_IMAGE_TAG}"
                memory = { "${env.K8S_PROCESS_MEMORY_HIGH}" as int * 1.MB * task.attempt }
            }
        }
    }

    if ( params.workflow == "medaka_artic" ) {
        // use more memory as this process runs a nextflow pipeline (Java)
        withName:ncov2019_artic_nf_pipeline_medaka {
            executor = 'k8s'
            container = "${env.DOCKER_IMAGE_PREFIX}/ncov2019-artic-nf-nanopore:${env.DOCKER_IMAGE_TAG}"
            memory = { "${env.K8S_PROCESS_MEMORY_VERY_HIGH}" as int * 1.MB * task.attempt }
        }
    }

    withName:load_ncov_data_to_db {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:pangolin_pipeline {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/pangolin:${env.DOCKER_IMAGE_TAG}"
        memory = { "${env.K8S_PROCESS_MEMORY_HIGH}" as int * 1.MB * task.attempt }
    }
    withName:merge_pangolin_files {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:load_pangolin_data_to_db {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:create_genbank_submission_files {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:submit_genbank_files {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
    withName:mark_samples_as_submitted_to_genbank {
        executor = 'k8s'
        container = "${env.DOCKER_IMAGE_PREFIX}/covid-pipeline:${env.DOCKER_IMAGE_TAG}"
    }
}
